// Prisma Schema for ExpensesTracker
// Database: SQLite for development simplicity
// Currency stored as integers in cents for accuracy

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                String            @id @default(uuid())
  email             String            @unique
  passwordHash      String
  twoFactorEnabled  Boolean           @default(false)
  twoFactorEmail    String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  accounts          Account[]
  expenseCategories ExpenseCategory[]
  transactions      Transaction[]
  debts             Debt[]
  twoFactorCodes    TwoFactorCode[]

  @@map("users")
}

model Account {
  id                   String        @id @default(uuid())
  userId               String
  name                 String
  allocationPercentage Int // Stored as integer 0-100
  isDefault            Boolean       @default(false) // Default account that absorbs remaining allocation
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  user                 User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions         Transaction[]
  debts                Debt[]

  @@index([userId])
  @@map("accounts")
}

model ExpenseCategory {
  id           String        @id @default(uuid())
  userId       String
  name         String // e.g. "Rent", "Groceries"
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([userId])
  @@map("expense_categories")
}

model Transaction {
  id                String           @id @default(uuid())
  userId            String
  accountId         String // Source of funds (or destination for Income)
  expenseCategoryId String? // Classification (Optional for Income or Transfers)
  type              TransactionType
  amountCents       Int // CRITICAL: Store as cents (integer) for accuracy
  description       String
  sourceDescription String? // For income source
  transactionDate   DateTime
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  account           Account          @relation(fields: [accountId], references: [id], onDelete: Restrict)
  expenseCategory   ExpenseCategory? @relation(fields: [expenseCategoryId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([accountId])
  @@index([expenseCategoryId])
  @@index([transactionDate])
  @@index([type])
  @@map("transactions")
}

enum TransactionType {
  INCOME
  EXPENSE
}

model Debt {
  id          String   @id @default(uuid())
  userId      String
  personName  String
  amountCents Int // Positive = they owe you, Negative = you owe them
  description String
  type        DebtType
  isPaid      Boolean  @default(false)
  dueDate     DateTime?
  accountId   String? // Account to deduct from (OWED_TO_ME) or add to (OWED_BY_ME) when paid
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  account     Account? @relation(fields: [accountId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([isPaid])
  @@index([accountId])
  @@map("debts")
}

enum DebtType {
  OWED_TO_ME // Someone owes you money
  OWED_BY_ME // You owe someone money
}

model TwoFactorCode {
  id        String   @id @default(uuid())
  userId    String
  code      String
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
  @@map("two_factor_codes")
}